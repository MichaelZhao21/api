<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>App Usage!</title>

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.4/dayjs.min.js"
            integrity="sha256-NTsR4SOm3YHfJrmrmvBtEYqfQ6jQ5yvEKMhgQe3DIl0=" crossorigin="anonymous"></script>

        <script lang="javascript" type="text/javascript">
            let listStore = [];

            async function getReq(name = '') {
                return new Promise((resolve, reject) => {
                    $.get(`/usage/data/${name}`, data => resolve(data)).fail(() => {
                        reject('Failed to get data')
                    });
                })
            }

            async function fetchData() {
                const name = $('#name-picker').val();
                if (name === 'default') return;
                listStore = await getReq(name);
                createVisuals();
            }

            async function createVisuals() {
                const table = $('#table');
                table.html('');
                const split = getIntervalData().map(l => dayjs(l).format('MMM D, YYYYTh:mm a').split('T'));
                split.forEach(s => {
                    let row = $('<div class="table-row"></div>');
                    row.append($(`<p class="table-item date">${s[0]}</p>`));
                    row.append($(`<p class="table-item time">${s[1]}</p>`));
                    table.append(row);
                });
            }

            function getIntervalData() {
                let now = dayjs();
                let start;
                const interval = $('#interval-picker').val();

                if (interval === 'all') return listStore;
                else if (interval === '3hour') start = now.subtract(3, 'hour');
                else start = now.subtract(1, interval);

                console.log(now);
                console.log(start);
                
                let minTime = start.valueOf();
                let i = 0;
                for (i = listStore.length - 1; i >= 0; i--) {
                    if (listStore[i] < minTime) break;
                }
                
                return listStore.slice(i + 1);
            }

            $(document).ready(async () => {
                const dropdown = $('#name-picker');
                try {
                    const names = await getReq();
                    names.forEach(name => {
                        dropdown.append($(`<option value=${name}>${name}</option>`));
                    });
                    $('#message').text('Please pick a name to show its data!');
                } catch (error) {
                    console.error(error);
                    $('#message').text('Could not fetch data :(');
                }
            });
        </script>

        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;500&display=swap" rel="stylesheet">

        <style>
            html {
                font-size: 16px;
            }

            body {
                font-family: 'Roboto';
                font-weight: 500;
                text-align: center;
            }

            h1 {
                font-weight: 300;
                font-size: 4rem;
            }

            #table {
                width: 14rem;
                margin: auto;
                display: flex;
                flex-direction: column;
            }

            .table-row {
                display: flex;
                flex-direction: row;
            }

            .table-item {
                margin: 0.1rem;
                width: 7rem;
            }
        </style>
    </head>

    <body>
        <h1>App Usage Logs :)</h1>
        <select id="name-picker" onchange="fetchData()">
            <option value="default" selected>Pick a name...</option>
        </select>
        <select id="interval-picker" onchange="createVisuals()">
            <option value="hour">Last Hour</option>
            <option value="3hour" selected>Last 3 Hours</option>
            <option value="day">Last Day</option>
            <option value="week">Last Week</option>
            <option value="month">Last Month</option>
            <option value="all">All Time</option>
        </select>
        <div id="message-container">
            <p id="message">Loading...</p>
        </div>
        <div id="table"></div>
        <canvas id="graph"></canvas>
    </body>

</html>